{{- if .Values.pluginsEnabled -}}
{{- if ((.Values.plugins).retrohunt).enabled }}

apiVersion: batch/v1
kind: CronJob
metadata:
  name: plugin-retrohunt
  labels:
    part-of: azul
    section: plugins
    component: retrohunt
spec:
  schedule: "{{ .Values.plugins.retrohunt.schedule }}"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 2

  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        metadata:
          labels:
            app: plugin-retrohunt
            allow-egress-dispatcher: "true"
            allow-egress-https: "true"
            part-of: azul
            section: plugins
            component: retrohunt
        spec:
          restartPolicy: OnFailure

          {{- with .Values.imagePullSecrets }}
          imagePullSecrets:
            {{- toYaml . | nindent 12 }}
          {{- end }}

          containers:
            - name: retrohunt-cron
              image: {{ include "image.custom" (dict "images" .Values.images "name" "plugin-retrohunt") }}
              imagePullPolicy: {{ .Values.images.pullPolicy }}

              command: ["azul-plugin-retrocron"]

              envFrom:
                - configMapRef:
                    name: plugin-standard
                - configMapRef:
                    name: plugin-retrohunt

              env:
                - name: PLUGIN_DEPLOYMENT_KEY
                  value: plugin-retrohunt

{{- end }}
{{- end }}