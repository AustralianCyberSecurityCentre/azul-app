{{- if .Values.pluginsEnabled -}}
{{- $root := .Values }}
{{- $group := .Values.plugins.maco }}
{{- $group_name := "maco" }}
{{- range $k, $source := $group.sources }}
  {{- if $source.enabled }}
    {{- $plugin := printf "plugin-maco-%s" $k }}
    {{- $image := $group.image }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $plugin }}
  labels:
    part-of: azul
    section: plugins
    component: {{ $group_name }}
spec:
  revisionHistoryLimit: 1
  selector:
    matchLabels:
      app: {{ $plugin }}
      ruleset: {{ $k }}
  template:
    metadata:
      name: {{ $plugin }}
      labels:
        app: {{ $plugin }}
        part-of: azul
        section: plugins
        component: {{ $group_name }}
        ruleset: {{ $k }}
        allow-egress-dispatcher: "true"
        allow-egress-https-ssh: "true"
      {{- with $root.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    spec:
      {{- with $root.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $root.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $root.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $root.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- include "harden.deployment" . | nindent 6 }}
      containers:
      - name: main
        image: {{ include "image.custom" (dict "images" $root.images "name" $image)}}
        # extractor requirements can have relative path imports, so must be in correct dir
        # even when using MaCo venvs
        workingDir: /code/dest/{{ $source.path | default "" }}
        imagePullPolicy: {{ $root.images.pullPolicy }}
        {{- include "harden.container" . | nindent 8 }}
        {{- if $group.resources }}
        resources:
          {{- $group.resources | toYaml | nindent 10 }}
        {{- end }}
        envFrom:
        - configMapRef:
            name: plugin-standard
        {{- if $group.config }}
        - configMapRef:
            name: {{ printf "plugin-%s" $group_name }}
        {{- end }}
        env:
        {{- with $source.env }}
        {{- . | toYaml | nindent 8 }}
        {{- end }}
        - name: PLUGIN_NAME_SUFFIX
          value: {{ $k }}
        - name: PLUGIN_SECURITY_OVERRIDE
          value: {{ $source.security | default "OFFICIAL" }}
        - name: PLUGIN_WATCH_PATH
          value: /code/dest/{{ $source.path | default "" }}
        - name: PLUGIN_WATCH_TYPE
          value: git
        - name: PLUGIN_WATCH_WAIT
          value: "{{ $source.wait | default "30" }}"
        {{- if $source.maxFileSize }}
        - name: PLUGIN_FILTER_MAX_CONTENT_SIZE
          value: "{{ $source.maxFileSize }}"
        {{- end }}
        - name: PLUGIN_SCRIPTS
          value: /code/dest/{{ $source.path | default "" }}
        - name: PLUGIN_DEPLOYMENT_KEY
          value: "{{ $plugin }}"
        {{- if $root.CACertificateConfigMap }}
        - name: SSL_CERT_FILE
          value: /etc/ssl/certs/ca-certificates.crt
        - name: REQUESTS_CA_BUNDLE
          value: /etc/ssl/certs/ca-certificates.crt
        {{- end }}
        volumeMounts:
        - name: tmp
          mountPath: /tmp/
        - name: code
          mountPath: /code
        - name: local
          mountPath: /home/azul/.local/
        - name: cache
          mountPath: /home/azul/.cache/
        - name: plugin-gitconfig
          mountPath: /home/azul/.gitconfig
          subPath: .gitconfig
        {{- if $root.pipconfig }}
        - name: plugin-pipconfig
          mountPath: /etc/pip.conf
          subPath: pip.conf
        {{- end }}
        {{- if $root.CACertificateConfigMap }}
        - mountPath: /etc/ssl/certs/ca-certificates.crt
          name: ca-cert
          subPath: ca.crt
        {{- end }}
      {{- include "plugin.container.source.loop" (dict "root" $ "source" $source ) | nindent 6 }}
      volumes:
      - name: tmp
        emptyDir:
          # venv install can be quite large
          sizeLimit: {{ $source.tmp | default "400Mi" }}
      - name: code
        emptyDir: {}
      - name: local
        emptyDir: {}
      - name: cache
        emptyDir: {}
      - name: plugin-gitconfig
        configMap:
          name: plugin-gitconfig
      {{- if $root.pipconfig }}
      - name: plugin-pipconfig
        configMap:
          name: plugin-pipconfig
      {{- end }}
      {{- if $root.CACertificateConfigMap }}
      - name: ca-cert
        configMap:
          name: {{ $root.CACertificateConfigMap }}
      {{- end }}
      {{- if $source.secretSSH}}
      - name: ssh
        secret:
          defaultMode: 0400
          secretName: {{ $source.secretSSH }}
      {{- end }}
  {{- include "hpa" (dict "root" $ "name" $plugin "min" $root.pluginSyncHPA.minReplicas "max" $root.pluginSyncHPA.maxReplicas "avgUtil" $root.pluginSyncHPA.averageUtilization "useSmartScaler" $.Values.pluginSyncHPA.useSmartScaler "includeHistoric" $.Values.pluginSyncHPA.includeHistoric "maxQueueLength" $.Values.pluginSyncHPA.maxQueueLength) | nindent 0 }}
  {{- end }}
{{- end }}
{{- end }}
